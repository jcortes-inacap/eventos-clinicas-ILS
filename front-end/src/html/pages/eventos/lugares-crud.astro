---
import AdminLayout from '../../layouts/admin/admin-layout.astro'
import PageHeader from '../../components/common/page-header.astro'
import type { Props as PageHeaderProps } from '../../components/common/page-header.astro'
import { getPathPrefix } from '../../../utils/path.js'
import { ApiService } from '../../../services/api.js'

// Obtener datos reales desde la API
let lugares = []
let hasError = false

try {
  const response = await ApiService.getLugares()
  lugares = response.data || []
} catch (error) {
  console.error('Error fetching lugares:', error)
  hasError = true
}

const lugaresPageConfig: PageHeaderProps = {
  title: 'Gestión de Lugares',
  breadcrumbs: [
    { label: 'Dashboard', href: getPathPrefix('/dashboard'), class: '' },
    { label: 'Other Pages', class: '' },
    { label: 'Lugares CRUD', class: 'active' }
  ]
}
---

<AdminLayout
  title="Gestión de Lugares"
  description="Administración de lugares del sistema"
  currentPath="/others/lugares-crud"
>
  <PageHeader {...lugaresPageConfig} />

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Lista de Lugares</h5>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLugarModal">
            <i class="ri-add-line me-1"></i> Nuevo Lugar
          </button>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-8">
              <div class="input-group">
                <span class="input-group-text">
                  <i class="ri-search-line"></i>
                </span>
                <input 
                  type="text" 
                  class="form-control" 
                  id="searchInput" 
                  placeholder="Buscar por nombre, dirección o tipo..."
                >
              </div>
            </div>
            <div class="col-md-4 text-end">
              <button class="btn btn-outline-secondary" id="sortButton">
                <i class="ri-sort-asc"></i> Ordenar A-Z
              </button>
            </div>
          </div>

          {hasError ? (
            <div class="alert alert-danger" role="alert">
              <i class="ri-error-warning-line me-2"></i>
              Error al cargar los lugares. Por favor, intente nuevamente.
            </div>
          ) : lugares.length === 0 ? (
            <div class="alert alert-info" role="alert">
              <i class="ri-information-line me-2"></i>
              No hay lugares registrados en el sistema.
            </div>
          ) : (
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table">
                  <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Dirección</th>
                    <th>Tipo</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody id="lugaresTableBody">
                  {lugares.map((lugar) => (
                    <tr>
                      <td>
                        <small class="text-muted">#{lugar.id_lugar}</small>
                      </td>
                      <td>
                        <div class="d-flex align-items-center">
                          <div class="avatar-sm bg-light rounded-circle d-flex align-items-center justify-content-center ">
                          </div>
                          <div>
                            <div class="fw-medium">{lugar.nombre}</div>
                          </div>
                        </div>
                      </td>
                      <td>
                        <small class="text-muted">
                          <i class="ri-map-pin-2-line me-1"></i>
                          {lugar.direccion}
                        </small>
                      </td>
                      <td>
                        <span class="badge bg-danger">
                          {lugar.tipo}
                        </span>
                      </td>
                      <td class="text-end">
                          <button 
                            class="btn btn-sm btn-light me-2 edit-lugar" 
                            data-lugar-id={lugar.id_lugar}
                            title="Editar"
                          >
                            <i class="ri-edit-line"></i>
                          </button>
                          <button 
                            class="btn btn-sm btn-danger delete-lugar" 
                            data-lugar-id={lugar.id_lugar}
                            data-lugar-nombre={lugar.nombre}
                            title="Eliminar"
                          >
                            <i class="ri-delete-bin-line"></i>
                          </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
              <span id="paginationInfo" class="text-muted"></span>
            </div>
            <nav>
              <ul class="pagination mb-0" id="pagination"></ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Agregar Lugar -->
  <div class="modal fade" id="addLugarModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Nuevo Lugar</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
  <form id="addLugarForm" novalidate>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-12">
                <label for="add_nombre" class="form-label">Nombre <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="add_nombre" name="nombre" required maxlength="100">
                <small class="text-muted">Máximo 100 caracteres</small>
              </div>
              <div class="col-12">
                <label for="add_direccion" class="form-label">Dirección <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="add_direccion" name="direccion" required maxlength="255">
                <small class="text-muted">Dirección completa del lugar</small>
              </div>
              <div class="col-12">
                <label for="add_tipo" class="form-label">Tipo <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="add_tipo" name="tipo" required maxlength="60" placeholder="Ej: Auditorio, Sala, Laboratorio">
                <small class="text-muted">Tipo o categoría del lugar (máximo 60 caracteres)</small>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="addLugarBtn">
              <i class="ri-save-line me-1"></i> Guardar Lugar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal para Editar Lugar -->
  <div class="modal fade" id="editLugarModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Lugar</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="editModalBody">
          <!-- El contenido se carga dinámicamente -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="saveChangesBtn">Guardar cambios</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmación para eliminar -->
  <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">
            <i class="ri-error-warning-line me-2"></i>
            Confirmar Eliminación
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>¿Está seguro que desea eliminar el lugar <strong id="deleteLugarNombre"></strong>?</p>
          <div class="alert alert-warning">
            <i class="ri-alert-line me-2"></i>
            Esta acción no se puede deshacer. Solo se puede eliminar si no tiene eventos asociados.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
            <i class="ri-delete-bin-line me-1"></i>
            Eliminar Lugar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Script inline -->
  <script type="module">
    import Swal from 'https://cdn.jsdelivr.net/npm/sweetalert2@11/+esm'
    import { ApiService } from '/src/services/api.js'

    // Variables globales
    let currentLugarId = null
    let lugarToDelete = null
    let currentPage = 1
    const itemsPerPage = 10
    let filteredRows = []

    const tableBody = document.getElementById('lugaresTableBody')
    const allRows = tableBody ? [...tableBody.querySelectorAll('tr')] : []

    // Funciones de utilidad para UX
    const showLoading = (element, text = 'Cargando...') => {
      element.innerHTML = `
        <div class="d-flex align-items-center justify-content-center" style="min-height: 200px;">
          <div class="spinner-border text-primary me-2" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <span>${text}</span>
        </div>
      `
    }

    const showFieldAlert = (message, fieldId = null) => {
      Swal.fire({
        icon: 'warning',
        title: 'Revisa los campos',
        text: message,
        confirmButtonText: 'Entendido'
      }).then(() => {
        if (fieldId) {
          const field = document.getElementById(fieldId)
          if (field) {
            field.focus()
          }
        }
      })
    }

    const showRequestError = (title, message) => {
      Swal.fire({
        icon: 'error',
        title,
        text: message,
        confirmButtonText: 'Cerrar'
      })
    }

    const toggleFormInputs = (disabled) => {
      const inputs = document.querySelectorAll('#editLugarModal input, #editLugarModal select, #editLugarModal textarea')
      inputs.forEach(input => {
        input.disabled = disabled
      })
    }

    const toggleSaveButton = (disabled, text = 'Guardar cambios') => {
      const saveBtn = document.getElementById('saveChangesBtn')
      if (saveBtn) {
        saveBtn.disabled = disabled
        if (disabled && text === 'Guardando...') {
          saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Guardando...'
        } else {
          saveBtn.innerHTML = text
        }
      }
    }

    // Función para mostrar alerta de éxito
    const showSuccessAlert = (message, callback) => {
      const alertHtml = `
        <div class="modal fade" id="successModal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-body text-center py-4">
                <i class="ri-checkbox-circle-line text-success" style="font-size: 3rem;"></i>
                <h5 class="mt-3">${message}</h5>
              </div>
              <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
              </div>
            </div>
          </div>
        </div>
      `

      document.body.insertAdjacentHTML('beforeend', alertHtml)
      const successModal = new bootstrap.Modal(document.getElementById('successModal'))

      document.getElementById('successModal').addEventListener('hidden.bs.modal', () => {
        document.getElementById('successModal').remove()
        if (callback) callback()
      })

      successModal.show()
    }

    const createFormHTML = () => {
      return `
        <form id="editLugarForm" novalidate>
          <div class="row g-3">
            <div class="col-12">
              <label for="edit_nombre" class="form-label">Nombre <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="edit_nombre" name="nombre" required maxlength="100">
              <small class="text-muted">Máximo 100 caracteres</small>
            </div>
            <div class="col-12">
              <label for="edit_direccion" class="form-label">Dirección <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="edit_direccion" name="direccion" required maxlength="255">
              <small class="text-muted">Dirección completa del lugar</small>
            </div>
            <div class="col-12">
              <label for="edit_tipo" class="form-label">Tipo <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="edit_tipo" name="tipo" required maxlength="60" placeholder="Ej: Auditorio, Sala, Laboratorio">
              <small class="text-muted">Tipo o categoría del lugar (máximo 60 caracteres)</small>
            </div>
          </div>
        </form>
      `
    }

    // Función para limpiar el backdrop y resetear modales
    const cleanupModal = () => {
      const backdrop = document.querySelector('.modal-backdrop')
      if (backdrop) {
        backdrop.remove()
      }
      document.body.classList.remove('modal-open')
      document.body.style.overflow = ''
      document.body.style.paddingRight = ''
    }

    // Función de paginación
    const updatePagination = () => {
      const totalPages = Math.ceil(filteredRows.length / itemsPerPage)
      const pagination = document.getElementById('pagination')
      const paginationInfo = document.getElementById('paginationInfo')

      if (!pagination || !paginationInfo) return

      if (totalPages <= 1) {
        pagination.innerHTML = ''
        paginationInfo.textContent = `Mostrando ${filteredRows.length} lugares`
        return
      }

      let paginationHTML = ''

      // Botón anterior
      paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPage - 1}">
            <i class="ri-arrow-left-s-line"></i>
          </a>
        </li>
      `

      // Números de página
      for (let i = 1; i <= totalPages; i++) {
        paginationHTML += `
          <li class="page-item ${currentPage === i ? 'active' : ''}">
            <a class="page-link" href="#" data-page="${i}">${i}</a>
          </li>
        `
      }

      // Botón siguiente
      paginationHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPage + 1}">
            <i class="ri-arrow-right-s-line"></i>
          </a>
        </li>
      `

      pagination.innerHTML = paginationHTML

      // Info de paginación
      const startItem = (currentPage - 1) * itemsPerPage + 1
      const endItem = Math.min(currentPage * itemsPerPage, filteredRows.length)
      paginationInfo.textContent = `Mostrando ${startItem}-${endItem} de ${filteredRows.length} lugares`
    }

    const showPage = (page) => {
      currentPage = page
      const startIndex = (page - 1) * itemsPerPage
      const endIndex = startIndex + itemsPerPage

      // Ocultar todas las filas
      allRows.forEach(row => row.style.display = 'none')

      // Mostrar filas de la página actual
      filteredRows.slice(startIndex, endIndex).forEach(row => {
        row.style.display = ''
      })

      updatePagination()
    }

    // Inicializar paginación
    if (allRows.length > 0) {
      filteredRows = [...allRows]
      showPage(1)
    }

    // Event listeners para paginación
    document.addEventListener('click', function(e) {
      if (e.target.closest('.page-link')) {
        e.preventDefault()
        const page = parseInt(e.target.closest('.page-link').dataset.page)
        if (page && page !== currentPage && page >= 1 && page <= Math.ceil(filteredRows.length / itemsPerPage)) {
          showPage(page)
        }
      }
    })

    // Manejadores de modal
    const modalCancelButtons = document.querySelectorAll('[data-bs-dismiss="modal"]')
    modalCancelButtons.forEach(button => {
      button.addEventListener('click', () => {
        cleanupModal()
      })
    })

    const modals = document.querySelectorAll('.modal')
    modals.forEach(modal => {
      modal.addEventListener('hidden.bs.modal', () => {
        cleanupModal()
        toggleFormInputs(false)
        toggleSaveButton(false)
      })
    })

    // Lógica para agregar nuevo lugar
    const addLugarForm = document.getElementById('addLugarForm')
    
    if (addLugarForm) {
      addLugarForm.addEventListener('submit', async function(e) {
        e.preventDefault()

        const addBtn = document.getElementById('addLugarBtn')
        const originalText = addBtn ? addBtn.innerHTML : ''

        const formData = new FormData(this)

        const nombreValue = (formData.get('nombre') || '').trim()
        if (!nombreValue) {
          showFieldAlert('El nombre del lugar es obligatorio.', 'add_nombre')
          return
        }
        if (nombreValue.length > 100) {
          showFieldAlert('El nombre no puede superar los 100 caracteres.', 'add_nombre')
          return
        }

        const direccionValue = (formData.get('direccion') || '').trim()
        if (!direccionValue) {
          showFieldAlert('La dirección del lugar es obligatoria.', 'add_direccion')
          return
        }
        if (direccionValue.length > 255) {
          showFieldAlert('La dirección no puede superar los 255 caracteres.', 'add_direccion')
          return
        }

        const tipoValue = (formData.get('tipo') || '').trim()
        if (!tipoValue) {
          showFieldAlert('El tipo de lugar es obligatorio.', 'add_tipo')
          return
        }
        if (tipoValue.length > 60) {
          showFieldAlert('El tipo no puede superar los 60 caracteres.', 'add_tipo')
          return
        }

        if (addBtn) {
          addBtn.disabled = true
          addBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...'
        }

        const data = {
          nombre: nombreValue,
          direccion: direccionValue,
          tipo: tipoValue
        }

        const resetAddButton = () => {
          if (addBtn) {
            addBtn.disabled = false
            addBtn.innerHTML = originalText
          }
        }

        try {
          await ApiService.createLugar(data)
          
          const modal = bootstrap.Modal.getInstance(document.getElementById('addLugarModal'))
          modal.hide()

          showSuccessAlert('Lugar creado exitosamente', () => {
            window.location.reload()
          })
        } catch (error) {
          console.error('Error:', error)
          const apiMessage = error?.response?.data?.message || 'Ocurrió un problema al crear el lugar.'
          showRequestError('No se pudo crear el lugar', apiMessage)
          resetAddButton()
        }
      })
    }

    // Lógica para el modal de edición
    const editModal = document.getElementById('editLugarModal')
    const editButtons = document.querySelectorAll('.edit-lugar')

    editButtons.forEach(button => {
      button.addEventListener('click', async function() {
        currentLugarId = this.getAttribute('data-lugar-id')

        const modal = new bootstrap.Modal(editModal)
        modal.show()

        const modalBody = document.getElementById('editModalBody')
        showLoading(modalBody, 'Cargando datos del lugar...')
        toggleSaveButton(true, 'Cargando...')

        try {
          const response = await ApiService.getLugar(currentLugarId)
          const lugar = response.data

          modalBody.innerHTML = createFormHTML()

          document.getElementById('edit_nombre').value = lugar.nombre || ''
          document.getElementById('edit_direccion').value = lugar.direccion || ''
          document.getElementById('edit_tipo').value = lugar.tipo || ''

          toggleSaveButton(false)
        } catch (error) {
          modalBody.innerHTML = `
            <div class="alert alert-danger">
              <i class="ri-error-warning-line me-2"></i>
              Error al cargar los datos del lugar
            </div>
          `
          toggleSaveButton(true)
        }
      })
    })

    // Manejador para guardar cambios
    document.addEventListener('click', async function(e) {
      if (e.target && e.target.id === 'saveChangesBtn') {
        if (!currentLugarId) return

        const nombreValue = document.getElementById('edit_nombre').value.trim()
        if (!nombreValue) {
          showFieldAlert('El nombre del lugar es obligatorio.', 'edit_nombre')
          return
        }
        if (nombreValue.length > 100) {
          showFieldAlert('El nombre no puede superar los 100 caracteres.', 'edit_nombre')
          return
        }

        const direccionValue = document.getElementById('edit_direccion').value.trim()
        if (!direccionValue) {
          showFieldAlert('La dirección del lugar es obligatoria.', 'edit_direccion')
          return
        }
        if (direccionValue.length > 255) {
          showFieldAlert('La dirección no puede superar los 255 caracteres.', 'edit_direccion')
          return
        }

        const tipoValue = document.getElementById('edit_tipo').value.trim()
        if (!tipoValue) {
          showFieldAlert('El tipo de lugar es obligatorio.', 'edit_tipo')
          return
        }
        if (tipoValue.length > 60) {
          showFieldAlert('El tipo no puede superar los 60 caracteres.', 'edit_tipo')
          return
        }

        toggleFormInputs(true)
        toggleSaveButton(true, 'Guardando...')

        const formData = {
          nombre: nombreValue,
          direccion: direccionValue,
          tipo: tipoValue
        }

        try {
          await ApiService.updateLugar(currentLugarId, formData)

          const modal = bootstrap.Modal.getInstance(editModal)
          modal.hide()

          showSuccessAlert('Lugar actualizado exitosamente', () => {
            window.location.reload()
          })
        } catch (error) {
          console.error('Error:', error)
          const apiMessage = error?.response?.data?.message || 'Ocurrió un problema al actualizar el lugar.'
          showRequestError('No se pudo actualizar el lugar', apiMessage)
          toggleFormInputs(false)
          toggleSaveButton(false)
        }
      }

      // Manejador para eliminar lugar
      if (e.target.closest('.delete-lugar')) {
        const button = e.target.closest('.delete-lugar')
        lugarToDelete = {
          id: button.getAttribute('data-lugar-id'),
          nombre: button.getAttribute('data-lugar-nombre')
        }

        document.getElementById('deleteLugarNombre').textContent = lugarToDelete.nombre
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'))
        deleteModal.show()
      }

      // Confirmar eliminación
      if (e.target && e.target.id === 'confirmDeleteBtn') {
        if (!lugarToDelete) return

        const originalText = e.target.innerHTML
        e.target.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Eliminando...'
        e.target.disabled = true

        try {
          await ApiService.deleteLugar(lugarToDelete.id)

          const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'))
          modal.hide()

          showSuccessAlert('Lugar eliminado exitosamente', () => {
            window.location.reload()
          })
        } catch (error) {
          console.error('Error:', error)
          
          const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'))
          modal.hide()
          
          const apiMessage = error?.response?.data?.message || 'El lugar no se puede eliminar porque tiene eventos asociados.'
          showRequestError('No se pudo eliminar el lugar', apiMessage)
          e.target.innerHTML = originalText
          e.target.disabled = false
        }
      }
    })

    // Funcionalidad de búsqueda
    const searchInput = document.getElementById('searchInput')
    if (searchInput && allRows.length > 0) {
      searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase()

        filteredRows = allRows.filter(row => {
          const nombre = row.querySelector('td:first-child .fw-medium')?.textContent.toLowerCase() || ''
          const direccion = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || ''
          const tipo = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || ''
          return nombre.includes(searchTerm) || direccion.includes(searchTerm) || tipo.includes(searchTerm)
        })

        currentPage = 1
        showPage(1)
      })
    }

    // Funcionalidad de ordenamiento
    const sortButton = document.getElementById('sortButton')
    if (sortButton && allRows.length > 0) {
      let isAscending = true

      sortButton.addEventListener('click', function() {
        filteredRows.sort((a, b) => {
          const nombreA = a.querySelector('td:first-child .fw-medium')?.textContent.toLowerCase() || ''
          const nombreB = b.querySelector('td:first-child .fw-medium')?.textContent.toLowerCase() || ''

          return isAscending
            ? nombreA.localeCompare(nombreB)
            : nombreB.localeCompare(nombreA)
        })

        isAscending = !isAscending
        this.innerHTML = isAscending
          ? '<i class="ri-sort-asc"></i> Ordenar A-Z'
          : '<i class="ri-sort-desc"></i> Ordenar Z-A'

        showPage(currentPage)
      })
    }
  </script>
</AdminLayout>
