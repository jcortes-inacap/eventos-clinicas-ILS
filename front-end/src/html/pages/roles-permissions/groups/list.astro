---
// Imports
import { getAssetPrefix, getPathPrefix } from '../../../../utils/path.js'
import AdminLayout from '../../../layouts/admin/admin-layout.astro'
import type { Props as PageHeaderProps } from '../../../components/common/page-header.astro'
import PageHeader from '../../../components/common/page-header.astro'
import ConfirmationModal from '../../../components/common/confirmation-modal.astro'

// DataTables styles
const pageStyles = `
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.7/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-responsive-bs5@2.5.0/css/responsive.bootstrap5.min.css">
`

// DataTables scripts
const pageScript = `
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.7/js/jquery.dataTables.min.js"></script>
<script src="${getAssetPrefix('/assets/vendor/datatables/datatables.init.js')}"></script>
<script type="module" src="${getAssetPrefix('/assets/js/pages/roles-permissions/groups/table.js')}"></script>
`

interface Carrera {
  id_carrera: number
  descripcion: string
  estado: number
  id_area: number
  area?: {
    descripcion: string
  }
}

interface Area {
  id_area: number
  descripcion: string
  estado: number
}

// Leer filtros desde la URL
const url = new URL(Astro.request.url)
const estadoSeleccionado = url.searchParams.getAll('estado[]')
const idAreaSeleccionada = url.searchParams.get('id_area')

// Fetch de áreas
let areas: Area[] = []
try {
  const res = await fetch('http://localhost:3000/api/areas')
  const json = await res.json()
  areas = json.data || []
} catch (error) {
  console.error('Error al obtener áreas:', error)
}

// Construir query con filtros
let query = 'http://localhost:3000/api/carreras?'
if (estadoSeleccionado.length > 0) {
  estadoSeleccionado.forEach(e => query += `estado[]=${e}&`)
}
if (idAreaSeleccionada) {
  query += `id_area=${idAreaSeleccionada}`
}

// Fetch de carreras filtradas
let carreras: Carrera[] = []
try {
  const res = await fetch(query)
  const json = await res.json()
  carreras = json.data || []
} catch (error) {
  console.error('Error al obtener carreras:', error)
}

// Props para el encabezado
const pageHeaderProps: PageHeaderProps = {
  title: 'Carreras',
  breadcrumbs: [
    { label: 'Dashboard', href: getPathPrefix('/dashboard') },
    { label: 'Roles y Carreras', href: getPathPrefix('/roles-permissions') },
    { label: 'Carreras', class: 'active' }
  ],
  actions: [
    {
      label: 'Agregar Carrera',
      href: getPathPrefix('/roles-permissions/groups/add'),
      type: 'link',
      variant: 'btn-primary',
      icon: 'ri-add-line'
    }
  ]
}
---


<AdminLayout
  title="Carreras Inacap"
  description="Gestión de Carreras de Inacap"
  currentPath="roles-permissions/groups/list"
  pageScript={pageScript}
  pageCss={pageStyles}
>
  <PageHeader {...pageHeaderProps} />

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="astero-table">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-4">
              <!-- Buscador principal -->
              <div class="search-wrapper">
                <i class="ri-search-line search-icon"></i>
                <input
                  type="text"
                  class="form-control search-input"
                  data-table-filter="search"
                  placeholder="Buscar carreras..."
                />
                <button type="button" class="btn-clear search-clear" style="display: none;">
                  <i class="ri-close-line"></i>
                </button>
              </div>

              <!-- Botón filtros -->
              <button class="btn btn-outline-primary" data-bs-toggle="offcanvas" data-bs-target="#filterDrawer">
                <i class="ri-filter-2-line"></i> Filtros
              </button>
            </div>

            <!-- Drawer de filtros -->
            <div class="offcanvas offcanvas-end" tabindex="-1" id="filterDrawer">
              <div class="offcanvas-header border-bottom">
                <h5 class="offcanvas-title">Opciones de Filtro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
              </div>

              <div class="offcanvas-body">
                <form method="GET" action="/roles-permissions/groups/list" id="form-filtros" class="d-flex flex-column gap-3">
                  <!-- Estado -->
                  <div>
                    <label class="form-label fw-medium">Estado</label>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        name="estado[]"
                        value="1"
                        id="estado-activo"
                        checked={estadoSeleccionado.includes('1')}
                      />
                      <label class="form-check-label" for="estado-activo">Activa</label>
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        name="estado[]"
                        value="0"
                        id="estado-inactivo"
                        checked={estadoSeleccionado.includes('0')}
                      />
                      <label class="form-check-label" for="estado-inactivo">Inactiva</label>
                    </div>
                  </div>

                  <!-- Área -->
                  <div>
                    <label class="form-label fw-medium">Área</label>
                    <select class="form-select" name="id_area" id="id_area">
                      <option value="">Todas</option>
                      {areas.map(area => (
                        <option
                          value={area.id_area}
                          selected={idAreaSeleccionada == String(area.id_area)}
                        >
                          {area.descripcion}
                        </option>
                      ))}
                    </select>
                  </div>

                  <!-- Acciones -->
                  <div class="d-flex gap-2 mt-3">
                    <button type="submit" class="btn btn-primary flex-grow-1">Aplicar filtros</button>
                  </div>
                </form>
              </div>
            </div>

            <!-- Tabla -->
            <div class="table-container">
              <div class="table-responsive border-0">
                <table id="table_carreras" class="table align-middle">
                  <thead>
                    <tr>
                      <th class="text-center align-middle" style="width: 40px;">
                        <input class="form-check-input m-0" type="checkbox" data-table-select="select_all" />
                      </th>
                      <th>DESCRIPCIÓN</th>
                      <th>ÁREA</th>
                      <th>ESTADO</th>
                      <th class="text-end pe-3">Acción</th>
                    </tr>
                  </thead>
                  <tbody>
                    {carreras.map(carrera => (
                      carrera && typeof carrera.id_carrera === 'number' ? (
                        <tr>
                          <td class="text-center align-middle" style="width: 40px;">
                            <input class="form-check-input m-0" type="checkbox" data-row-id={carrera.id_carrera} />
                          </td>
                          <td>{carrera.descripcion}</td>
                          <td>{carrera.area?.descripcion ?? '-'}</td>
                          <td>{carrera.estado === 1 ? 'Activo' : 'Inactivo'}</td>
                          <td class="text-end">
                            <div class="dropdown text-end">
                              <button
                                class="btn btn-light btn-active-light-primary dropdown-toggle shadow-none action-btn"
                                type="button"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                              >
                                Acción
                              </button>
                              <ul class="dropdown-menu">
                                <li>
                                  <a
                                    href={`/roles-permissions/groups/add?id=${carrera.id_carrera}`}
                                    class="dropdown-item text-primary"
                                  >
                                    Editar
                                  </a>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                  <a
                                    class={`dropdown-item ${carrera.estado === 1 ? 'text-danger' : 'text-success'}`}
                                    href="#"
                                    onclick={`if (confirm('¿Estás seguro de que deseas ${carrera.estado === 1 ? 'desactivar' : 'activar'} esta carrera?')) {
                                      fetch('http://localhost:3000/api/carreras/${carrera.id_carrera}/toggle', {
                                        method: 'POST',
                                        headers: { 'Accept': 'application/json' }
                                      })
                                      .then(res => res.json())
                                      .then(data => {
                                        alert('Carrera actualizada: estado = ' + (data.estado === 1 ? 'Activo' : 'Inactivo'));
                                        location.reload();
                                      });
                                    } return false;`}
                                  >
                                    {carrera.estado === 1 ? 'Desactivar' : 'Activar'}
                                  </a>
                                </li>
                              </ul>
                            </div>
                          </td>
                        </tr>
                      ) : null
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ConfirmationModal />
</AdminLayout>
