---
import AdminLayout from '../../../layouts/admin/admin-layout.astro'
import PageHeader from '../../../components/common/page-header.astro'
import type { Props as PageHeaderProps } from '../../../components/common/page-header.astro'
import { getPathPrefix } from '../../../../utils/path.js'

// Fetch de áreas activas
interface Area {
  id_area: number
  descripcion: string
  estado: number
}

let areas: Area[] = []

try {
  const res = await fetch('http://localhost:3000/api/areas?estado=1')
  const json = await res.json()
  areas = json.data || []
} catch (error) {
  console.error('Error al obtener áreas activas:', error)
}

const pageHeaderProps: PageHeaderProps = {
  title: 'Agregar Carrera',
  breadcrumbs: [
    { label: 'Dashboard', href: getPathPrefix('/dashboard') },
    { label: 'Roles y Carreras', href: getPathPrefix('/roles-permissions') },
    { label: 'Carreras', href: getPathPrefix('/roles-permissions/groups/list') },
    { label: 'Agregar Carrera', class: 'active' }
  ],
  actions: [
    {
      label: 'Volver',
      href: getPathPrefix('/roles-permissions/groups/list'),
      type: 'link',
      variant: 'btn-outline-primary',
      icon: 'ri-arrow-left-s-line'
    }
  ]
}

const redirectUrl = getPathPrefix('/roles-permissions/groups/list')

const pageScript = `
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('carreraForm');
      const submitBtn = form.querySelector('button[type="submit"]');
      const spinner = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>';
      const redirectUrl = "${redirectUrl}";

      function showError(input, message) {
        const group = input.closest('.mb-3');
        group.classList.add('has-validation');
        input.classList.add('is-invalid');
        const existing = group.querySelector('.invalid-feedback');
        if (existing) existing.remove();
        const feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        feedback.textContent = message;
        input.after(feedback);
      }

      function clearError(input) {
        const group = input.closest('.mb-3');
        group.classList.remove('has-validation');
        input.classList.remove('is-invalid');
        const feedback = group.querySelector('.invalid-feedback');
        if (feedback) feedback.remove();
      }

      function validateForm() {
        let isValid = true;
        const descripcion = form.querySelector('#descripcion');
        const id_area = form.querySelector('#id_area');

        [descripcion, id_area].forEach(input => clearError(input));

        if (!descripcion.value.trim()) {
          showError(descripcion, 'El nombre de la carrera es obligatorio');
          isValid = false;
        }

        if (!id_area.value) {
          showError(id_area, 'Debes seleccionar un área');
          isValid = false;
        }

        return isValid;
      }

      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!validateForm()) return;

        submitBtn.disabled = true;
        submitBtn.innerHTML = spinner + 'Creando...';

        const descripcion = form.querySelector('#descripcion').value.trim();
        const id_area = form.querySelector('#id_area').value;
        const estado = form.querySelector('#estado').value;

        try {
          const res = await fetch('http://localhost:3000/api/carreras', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify({ descripcion, id_area, estado })
          });
          const data = await res.json();
          window.location.href = redirectUrl;
        } catch (error) {
          console.error('Error:', error);
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Crear Carrera';
          const alert = document.createElement('div');
          alert.className = 'alert alert-danger mt-3';
          alert.textContent = 'Ocurrió un error al crear la carrera. Intenta nuevamente.';
          form.insertBefore(alert, form.firstChild);
          setTimeout(() => alert.remove(), 5000);
        }
      });

      form.querySelectorAll('input, select').forEach(input => {
        input.addEventListener('input', function() {
          clearError(this);
        });
      });
    });
  </script>
`
---

<AdminLayout
  title="Agregar Carrera"
  description="Crear nueva carrera académica"
  currentPath="roles-permissions/groups/add"
  pageScript={pageScript}
>
  <PageHeader {...pageHeaderProps} />

  <form id="carreraForm" novalidate>
    <div class="row">
      <div class="col-md-8 mb-3">
        <div class="card">
          <div class="card-body">
            <!-- Nombre de la carrera -->
            <div class="row mb-3">
              <div class="col-12">
                <div class="form-group">
                  <label for="descripcion" class="form-label">Nombre de la carrera <span class="text-danger">*</span></label>
                  <input
                    type="text"
                    class="form-control"
                    id="descripcion"
                    name="descripcion"
                    placeholder="Ejemplo: Ingeniería en Informática"
                  />
                </div>
              </div>
            </div>

            <!-- Área -->
            <div class="row mb-3">
              <div class="col-12">
                <div class="form-group">
                  <label for="id_area" class="form-label">Área <span class="text-danger">*</span></label>
                  <select class="form-select" id="id_area" name="id_area" required>
                    <option value="">Seleccionar área</option>
                    {areas.map(area => (
                      <option value={area.id_area}>{area.descripcion}</option>
                    ))}
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-4 mb-3">
        <div class="card">
          <div class="card-body">
            <!-- Estado -->
            <div class="row mb-3">
              <div class="col-12">
                <div class="form-group">
                  <label for="estado" class="form-label">Estado <span class="text-danger">*</span></label>
                  <select class="form-select" id="estado" name="estado" required>
                    <option value="1" selected>Activa</option>
                    <option value="0">Inactiva</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="card-footer">
            <!-- Acciones -->
            <div class="d-flex flex-column flex-lg-row justify-content-end gap-2">
              <a href={getPathPrefix('/roles-permissions/groups/list')} class="btn btn-outline-secondary">Cancelar</a>
              <button type="submit" class="btn btn-primary">Crear Carrera</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</AdminLayout>