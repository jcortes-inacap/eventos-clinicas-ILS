---
import AdminLayout from '../../../layouts/admin/admin-layout.astro'
import PageHeader from '../../../components/common/page-header.astro'
import type { Props as PageHeaderProps } from '../../../components/common/page-header.astro'
import { getPathPrefix } from '../../../../utils/path.js'

interface Area {
  id_area: number
  descripcion: string
  estado: number
}

const url = new URL(Astro.request.url)
const id = url.searchParams.get('id')
let area: Area | null = null

if (id) {
  try {
    const response = await fetch(`http://localhost:3000/api/areas/${id}`)
    const json = await response.json()
    if (json && typeof json === 'object' && 'id_area' in json) {
      area = json
    } else {
      throw new Error('Estructura inesperada del JSON')
    }
  } catch (error) {
    console.error('Error en fetch:', error)
  }
}

const pageHeaderProps: PageHeaderProps = {
  title: 'Editar Área',
  breadcrumbs: [
    { label: 'Dashboard', href: getPathPrefix('/dashboard') },
    { label: 'Roles & Permissions', href: getPathPrefix('/roles-permissions') },
    { label: 'Permissions', href: getPathPrefix('/roles-permissions/permissions/list') },
    { label: 'Editar Área', class: 'active' }
  ],
  actions: [
    {
      label: 'Volver',
      href: getPathPrefix('/roles-permissions/permissions/list'),
      type: 'link',
      variant: 'btn-outline-primary',
      icon: 'ri-arrow-left-s-line'
    }
  ]
}
---

<AdminLayout title="Editar Área">
  <PageHeader {...pageHeaderProps} />

  {area ? (
    <form id="form-edicion">
      <input type="hidden" name="id_area" value={area.id_area} />

      <div class="row">
        <div class="col-md-8 mb-3">
          <div class="card">
            <div class="card-body">
              <div class="mb-3">
                <label for="descripcion" class="form-label">Área de estudio</label>
                <input
                  type="text"
                  class="form-control"
                  id="descripcion"
                  name="descripcion"
                  value={area.descripcion}
                  required
                />
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <div class="card">
            <div class="card-body">
              <div class="mb-3">
                <label for="estado" class="form-label">Estado</label>
                <select class="form-select" id="estado" name="estado" required>
                  <option value="1" selected={area.estado === 1}>Activa</option>
                  <option value="0" selected={area.estado === 0}>Inactiva</option>
                </select>
              </div>
            </div>
            <div class="card-footer">
              <div class="d-flex flex-column flex-lg-row justify-content-end gap-2">
                <a href="/roles-permissions/permissions/list" class="btn btn-outline-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary">Actualizar Área</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  ) : (
    <div class="alert alert-danger">No se pudo cargar el área</div>
  )}

  <script>
    document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('form-edicion') as HTMLFormElement
    form.addEventListener('submit', async (e) => {
      e.preventDefault()
      const formData = new FormData(form)
      const data: Record<string, string> = {}
      formData.forEach((value, key) => {
        data[key] = typeof value === 'string' ? value : ''
      })
      const id = data.id_area

      const res = await fetch(`http://localhost:3000/api/areas/${id}`, {
        method: 'PUT',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          descripcion: data.descripcion,
          estado: parseInt(data.estado)
        })
      })

      if (res.ok) {
        window.location.href = '/roles-permissions/permissions/list'
      } else {
        alert('Error al actualizar el área')
      }
    })
  })
  </script>
</AdminLayout>