---
import AdminLayout from '../../../layouts/admin/admin-layout.astro'
import PageHeader from '../../../components/common/page-header.astro'
import type { Props as PageHeaderProps } from '../../../components/common/page-header.astro'
import { getPathPrefix } from '../../../../utils/path.js'

const pageHeaderProps: PageHeaderProps = {
  title: 'Add Permission',
  breadcrumbs: [
    { label: 'Dashboard', href: getPathPrefix('/dashboard') },
    { label: 'Roles y Carreras', href: getPathPrefix('/roles-permissions') },
    { label: 'Areas', href: getPathPrefix('/roles-permissions/permissions/list') },
    { label: 'Agregar Carrera', class: 'active' }
  ],
  actions: [
    {
      label: 'Volver',
      href: getPathPrefix('/roles-permissions/permissions/list'),
      type: 'link',
      variant: 'btn-outline-primary',
      icon: 'ri-arrow-left-s-line'
    }
  ]
}

// Get the redirect URL for use in the script
const redirectUrl = getPathPrefix('/roles-permissions/permissions/list')

// Add custom validation script
const pageScript = `
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('permissionForm');
      const submitBtn = form.querySelector('button[type="submit"]');
      const spinner = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>';
      const redirectUrl = "${redirectUrl}"; // Use the pre-computed URL here

      // Function to show error feedback
      function showError(input, message) {
        const formGroup = input.closest('.mb-3');
        formGroup.classList.add('has-validation');
        input.classList.add('is-invalid');

        // Remove existing error message if any
        const existingFeedback = formGroup.querySelector('.invalid-feedback');
        if (existingFeedback) {
          existingFeedback.remove();
        }

        // Add new error message
        const feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        feedback.textContent = message;
        input.after(feedback);
      }

      // Function to clear error feedback
      function clearError(input) {
        const formGroup = input.closest('.mb-3');
        formGroup.classList.remove('has-validation');
        input.classList.remove('is-invalid');
        const feedback = formGroup.querySelector('.invalid-feedback');
        if (feedback) {
          feedback.remove();
        }
      }

      // Function to validate form
      function validateForm() {
        let isValid = true;
        const permissionTitle = form.querySelector('#permissionTitle');
        const displayName = form.querySelector('#displayName');
        const module = form.querySelector('#module');

        // Clear previous errors
        [permissionTitle, displayName, module].forEach(input => clearError(input));

        // Validate Permission Title
        if (!permissionTitle.value.trim()) {
          showError(permissionTitle, 'Permission title is required');
          isValid = false;
        } else if (!/^[a-z_]+$/.test(permissionTitle.value)) {
          showError(permissionTitle, 'Permission title should contain only lowercase letters and underscores');
          isValid = false;
        }

        // Validate Display Name
        if (!displayName.value.trim()) {
          showError(displayName, 'Display name is required');
          isValid = false;
        }

        // Validate Module
        if (!module.value) {
          showError(module, 'Please select a module');
          isValid = false;
        }

        return isValid;
      }

      // Form submission handler
      form.addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!validateForm()) {
          return;
        }

        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = spinner + 'Creating...';

        try {
          // Simulate API call (replace with your actual API endpoint)
          await new Promise(resolve => setTimeout(resolve, 2000));

          // On success
          window.location.href = redirectUrl; // Use the variable defined above
        } catch (error) {
          // On error
          console.error('Error:', error);
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Create Permission';

          // Show error alert
          const alert = document.createElement('div');
          alert.className = 'alert alert-danger mt-3';
          alert.textContent = 'An error occurred while creating the permission. Please try again.';
          form.insertBefore(alert, form.firstChild);

          // Remove alert after 5 seconds
          setTimeout(() => alert.remove(), 5000);
        }
      });

      // Real-time validation on input
      form.querySelectorAll('input, select').forEach(input => {
        input.addEventListener('input', function() {
          clearError(this);
        });
      });
    });
  </script>
`
---

<AdminLayout
  title="Agregar Area"
  description="Crear nuevas áreas de estudio"
  currentPath="roles-permissions/permissions/add"
>
  <PageHeader {...pageHeaderProps} />

  <div class="mb-3">
    <label for="descripcion" class="form-label">Área de estudio</label>
    <input type="text" class="form-control" id="descripcion" required />
  </div>

  <div class="mb-3">
    <label for="estado" class="form-label">Estado</label>
    <select class="form-select" id="estado" required>
      <option value="1" selected>Activa</option>
      <option value="0">Inactiva</option>
    </select>
  </div>

  <button
    class="btn btn-primary"
    onclick={`const descripcion = document.getElementById('descripcion').value.trim();
              const estado = document.getElementById('estado').value;
              if (!descripcion) { alert('La descripción es obligatoria'); return false; }
              fetch('http://localhost:3000/api/areas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify({ descripcion, estado })
              })
              .then(res => res.json())
              .then(data => {
                alert('Área creada correctamente: ID = ' + data.id_area);
                location.href = '/roles-permissions/permissions/list';
              })
              .catch(err => {
                console.error(err);
                alert('Error al crear el área');
              });
              return false;`}
  >
    Crear Área
  </button>
</AdminLayout>
