---
import AdminLayout from '../../../layouts/admin/admin-layout.astro'
import PageHeader from '../../../components/common/page-header.astro'
import type { Props as PageHeaderProps } from '../../../components/common/page-header.astro'
import { getPathPrefix } from '../../../../utils/path.js'

const pageHeaderProps: PageHeaderProps = {
  title: 'Agregar Rol',
  breadcrumbs: [
    { label: 'Panel', href: getPathPrefix('/dashboard') },
    { label: 'Roles y Permisos', href: getPathPrefix('/roles-permissions') },
    { label: 'Roles', href: getPathPrefix('/roles-permissions/roles/list') },
    { label: 'Agregar Rol', class: 'active' }
  ],
  actions: [
    {
      label: 'Volver',
      href: getPathPrefix('/roles-permissions/roles/list'),
      type: 'link',
      variant: 'btn-outline-primary',
      icon: 'ri-arrow-left-s-line'
    }
  ]
}
---

<AdminLayout
  title="Agregar Rol"
  description="Crear un nuevo rol"
  currentPath="roles-permissions/roles/add"
>
  <PageHeader {...pageHeaderProps} />

  <!-- FORMULARIO PARA CREAR ROL -->
  <form id="roleForm" novalidate>
    <div class="row justify-content-center">
      <div class="col-md-8 mb-3">
        <div class="card">
          <div class="card-body">
            <!-- Descripción del Rol -->
            <div class="mb-3">
              <label for="roleName" class="form-label">
                Descripción del Rol <span class="text-danger">*</span>
              </label>
              <input
                type="text"
                class="form-control"
                id="roleName"
                name="roleName"
                placeholder="Ingrese la Descripción del rol"
                required
              />
            </div>

            <!-- Estado -->
            <div class="mb-3">
              <label for="status" class="form-label">
                Estado <span class="text-danger">*</span>
              </label>
              <select class="form-select" id="status" name="status" required>
                <option value="1" selected>Activo</option>
                <option value="0">Inactivo</option>
              </select>
            </div>
          </div>

          <div class="card-footer">
            <div class="d-flex justify-content-end gap-2">
              <a href={getPathPrefix('/roles-permissions/roles/list')} class="btn btn-outline-secondary">
                Cancelar
              </a>
              <button type="submit" class="btn btn-primary">Crear Rol</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- Script para manejar envío -->
  <script type="module">
    const form = document.getElementById('roleForm');

    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // evita recarga de página

      // Capturar los valores del formulario
      const data = {
        descripcion: form.roleName.value.trim(),
        estado: parseInt(form.status.value)
      };

      // Validación simple antes de enviar
      if (!data.descripcion) {
        alert('La descripción del rol es obligatoria.');
        return;
      }

      try {
        // Ajusta la URL si tu backend Laravel no corre en el mismo dominio
        const res = await fetch('http://localhost:8000/api/roles', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await res.json();

        if (res.ok) {
          alert('Rol creado correctamente: ' + result.rol.descripcion);
          form.reset();
        } else {
          alert('Error: ' + (result.message || 'No se pudo crear el rol'));
        }
      } catch (err) {
        console.error(err);
        alert('Error de conexión con el servidor.');
      }
    });
  </script>
</AdminLayout>
