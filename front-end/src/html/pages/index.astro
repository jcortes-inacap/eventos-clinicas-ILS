---
import AdminLayout from '../../../layouts/admin/admin-layout.astro';
import PageHeader from '../../../components/common/page-header.astro';
import type { Props as PageHeaderProps } from '../../../components/common/page-header.astro';
import { getPathPrefix } from '../../../../utils/path.js';

// Configuración del encabezado de la página
const pageHeaderProps: PageHeaderProps = {
  title: 'Roles',
  breadcrumbs: [
    { label: 'Dashboard', href: getPathPrefix('/dashboard'), class: '' },
    { label: 'Roles & Permissions', href: getPathPrefix('/roles-permissions'), class: '' },
    { label: 'Roles', class: 'active' }
  ],
  actions: [
    {
      label: 'Agregar Rol',
      href: getPathPrefix('/roles-permissions/roles/add'),
      type: 'link',
      variant: 'btn-primary',
      icon: 'ri-add-line'
    }
  ]
};

// -------------------------
// Fetch de roles desde la API en SSR
// -------------------------
let roles = [];

try {
  const res = await fetch('http://localhost:8000/api/roles');
  if (!res.ok) throw new Error('Error al obtener roles desde la API');
  roles = await res.json();
} catch (err) {
  console.error('Error fetching roles:', err);
  roles = [];
}
---

<AdminLayout
  title="Roles"
  description="Gestión de Roles"
  currentPath="roles-permissions/roles/list"
>
  <PageHeader {...pageHeaderProps} />

  <!-- Roles Cards -->
  <div class="row g-4">
    {roles.length === 0 ? (
      <p class="text-center text-muted">No hay roles disponibles</p>
    ) : (
      roles.map((role) => (
        <div class="col-12 col-md-6 col-xl-3">
          <div class="card h-100">
            <div class="card-header pb-2">
              <h5 class="fw-semibold text-capitalize mb-2">{role.descripcion}</h5>
              <p class="text-muted small mb-0">ID: {role.id}</p>
              <p class="text-muted small mb-0">Estado: {role.estado === 1 ? 'Activo' : 'Inactivo'}</p>
            </div>
            <div class="card-body p-2 d-flex flex-column">
              <ul class="list-unstyled mb-0">
                <li class="text-muted fst-italic small">Permisos no disponibles</li>
              </ul>
            </div>
            <div class="card-footer d-flex justify-content-between gap-2">
              <a
                href={getPathPrefix(`/roles-permissions/roles/edit/${role.id}`)}
                class="btn btn-sm btn-outline-secondary px-3 py-1"
              >
                Editar
              </a>
              <button
                class="btn btn-sm btn-outline-danger px-3 py-1"
                onClick={async () => {
                  if (!confirm('¿Deseas desactivar este rol?')) return;
                  try {
                    const res = await fetch(`http://localhost:8000/api/roles/${role.id}`, { method: 'DELETE' });
                    if (!res.ok) throw new Error('Error al desactivar');
                    alert('Rol desactivado correctamente');
                    // Remover card del DOM
                    const card = document.currentScript.closest('.col-12.col-md-6.col-xl-3');
                    card?.remove();
                  } catch (err) {
                    console.error(err);
                    alert('No se pudo desactivar el rol');
                  }
                }}
              >
                Desactivar
              </button>
            </div>
          </div>
        </div>
      ))
    )}
  </div>
</AdminLayout>
